# VBF3とナイーブなRedisのセットとの比較

VBF3 on Redis(以下V)とナイーブなRedisのセット(以下N)の
パフォーマンスを比較する。

比較対象は主にRedisの速度とメモリ。
どちらにせよRedis側の操作(及び通信)が支配的になるため。

## ナイーブなブルームフィルタの実装方式

追加は SETEX でキーにIDを指定する。IDが長いほどメモリを使う。

各キーにはTTLを指定する。これはVBF3のgenerationに相当する。

存在チェックは GET で行う。

## 速度

Nでは追加もチェックも1操作で行える。
1操作はパイプラインを使用しない場合は約 500~600μ秒かかる。
(パイプラインを使用して多数の操作をまとめた場合は約2μ秒程度にまで短縮できる)

Vでは追加もチェックもに3操作かかる。
これはパイプラインを3回使うという意味でもあるので
1.5m秒程度かかっていると推定される。
(ここは再度要検証)

つまり **VはNの3倍遅い** 。

## メモリ

Nでは要素を1つ追加するのにおおよそ約54バイトのオーバーヘッドがかかる。
これに加えて要素のバイト長を必要とする。
すなわち追加する要素数を `n` とすると必要なメモリは `O(n)` となる。
これをより正確に表すと以下の通りとなる。

```
{1要素あたりに必要なビット数} = (54 + {要素のバイト長}) * 8
```

一方でVでは要素のバイト長は関係なく、必要な誤り率の設定で決まる。
なお通常のブルームフィルタにおいては、
誤り率を 1% (0.01) とした場合の1要素あたりに必要なビット数は 9.6 となる。
加えて要素ごとに4.8ビットの領域を追加するごとに、
誤り率を1/10できる。
[参照](https://ja.wikipedia.org/wiki/%E3%83%96%E3%83%AB%E3%83%BC%E3%83%A0%E3%83%95%E3%82%A3%E3%83%AB%E3%82%BF#%E7%A9%BA%E9%96%93%E7%9A%84/%E6%99%82%E9%96%93%E7%9A%84%E3%81%AA%E5%84%AA%E4%BD%8D%E6%80%A7)

VBF3では忘却機能のために
通常のブルームフィルタにおける1ビットを8ビットに展開することに注意が必要。
これをより正確に表すと以下の通りとなる。

```
{1要素あたりに必要なビット数} = (4.8 * -log10({必要な誤り率})) * 8

{必要な誤り率} < 1.0
```

このことから通常はVのほうがNよりもメモリ効率が良いが、
必要な誤り率が小さく設定しすぎると逆転することが考えられる。
たとえばNにおいて要素の長さを32バイトとした場合は、
`86 / 4.8 = 17.916...` となり、
おおよその誤り率 `10^(-17.9)` までは V のほうが効率が良いことになる。

仮にNにおいて要素の長さを無視して0とした場合は
`54 / 4.8 = 11.25` となり
誤り率 `10^(-11.25)` がその分岐点となる。
これはおよそ 177億分の1 という確率になる。

以下のテーブルはNにおいて要素の長さを決めた場合に、
誤り率の設定でメモリ効率比(VがNに比べてどれだけ優れているか。大きいほど良い)がどのように変化するかを示している。

誤り率 | メモリ効率比(要素長さ0) | メモリ効率(要素長さ32)
------:|------------------------:|-----------------------------:
0.01   |5.63                     |8.96
0.001  |3.75                     |5.97
0.0001 |2.81                     |4.48
0.00001|2.25                     |3.58

以下はその計算式

```
p: 誤り率
n: 要素の長さ

(54 + n) / (4.8 * -(math.log10(p)))
```
