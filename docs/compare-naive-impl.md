# VBF3とナイーブなRedisのセットとの比較

本文章では
Redisをバックエンドとした忘却付きのブルームフィルタであるVBF3(以下V)と
ナイーブなRedisのセット(以下N)のパフォーマンスを比較する。

比較対象は主にRedisの速度とメモリ。
これはVでもNでもどちらにせよRedis側の操作(及び通信)がそれらのパフォーマンスにとって支配的になるため。

*   [速度の比較](#速度)
*   [メモリの比較](#メモリ)

## ナイーブなブルームフィルタの実装方式

追加は SETEX でキーにIDを指定する。IDが長いほどメモリを使う。

各キーにはTTLを指定する。これはVBF3のgenerationに相当する。

存在チェックは GET で行う。

## 速度

Nでは追加もチェックも1操作で行える。
1操作はパイプラインを使用しない場合には約500~600μ秒かかる。
(パイプラインを使用して多数の操作をまとめた場合は約2μ秒程度にまで圧縮できる)

Vでは追加もチェックも3操作かかる。
これはパイプラインを3回使うという意味でもあるので
最速でも1.5m秒程度かかっている。

つまり **VはNの3倍遅い** 。

## メモリ

Nでは要素を1つ追加するのにおおよそ約54バイトのオーバーヘッドがかかる。
これに加えて要素のバイト長を必要とする。
すなわち追加する要素数を `n` とすると必要なメモリは `O(n)` となる。
これをより正確に表すと以下の通りとなる。

```
{1要素あたりに必要なビット数} = (54 + {要素のバイト長}) * 8
```

一方でVでは要素のバイト長は関係なく、必要な誤り率の設定で決まる。
なお通常のブルームフィルタにおいては、
誤り率を 1% (0.01) とした場合の1要素あたりに必要なビット数は 9.6 となる。
加えて要素ごとに4.8ビットの領域を追加するごとに、
誤り率を1/10できる。
([参照](https://ja.wikipedia.org/wiki/%E3%83%96%E3%83%AB%E3%83%BC%E3%83%A0%E3%83%95%E3%82%A3%E3%83%AB%E3%82%BF#%E7%A9%BA%E9%96%93%E7%9A%84/%E6%99%82%E9%96%93%E7%9A%84%E3%81%AA%E5%84%AA%E4%BD%8D%E6%80%A7))

VBF3では忘却機能のために
通常のブルームフィルタにおける1ビットを8ビットに展開することに注意が必要。
これをより正確に表すと以下の通りとなる。

```
{1要素あたりに必要なビット数} = (4.8 * -log10({必要な誤り率})) * 8

{必要な誤り率} < 1.0
```

このことから通常はVのほうがNよりもメモリ効率が良いが、
必要な誤り率が小さく設定しすぎると逆転することが考えられる。
たとえばNにおいて要素の長さを32バイトとした場合は、
`86 / 4.8 = 17.916...` となり、
おおよその誤り率 `10^(-17.9)` までは V のほうが効率が良いことになる。

仮にNにおいて要素の長さを無視して0とした場合は
`54 / 4.8 = 11.25` となり
誤り率 `10^(-11.25)` がその分岐点となる。
これはおよそ 177億分の1 という確率になる。

以下のテーブルはNにおいて要素の長さ(バイト)を決めた場合に、
誤り率の設定でメモリ効率比がどのように変化するかを示している。
メモリ効率比はVがNに比べてどれだけ優れているかであり、大きいほど良い。

誤り率\要素長 | 0 バイト | 32 バイト | 128 バイト | 1024 バイト
---:|---:|---:|---:|---:
0.01 | 5.62 | 8.96 | 18.96 | 112.29
0.001 | 3.75 | 5.97 | 12.64 | 74.86
0.0001 | 2.81 | 4.48 | 9.48 | 56.15
1e-05 | 2.25 | 3.58 | 7.58 | 44.92
1e-06 | 1.88 | 2.99 | 6.32 | 37.43

以下はその計算式

```
p: 誤り率
n: 要素の長さ

{メモリ効率比} = (54 + n) / (4.8 * -(math.log10(p)))
```

## パラメーターの見積もり

[Bloom Filter Calculator](https://hur.st/bloomfilter/) を用いて
ブルームフィルタに格納する要素数(`n`)と必要な精度(確率 `p`)から
最適なパラメーター `m` および `k` を決定できる。

仮に `n` を10億(=10^9 = `1G`)とした場合の `p` と `m`, `k` の値は次のようになる。

`p` \ パラメーター | `m` | `k`
------------------:|----:|----:
0.1   |  4.8G |  3
0.01  |  9.6G |  7
0.001 | 14.4G | 10
1e-4  | 19.2G | 13
1e-5  | 24.0G | 17
1e-6  | 28.7G | 20

`m` に使われている `G` は `10^9` の意味で10億バイトに相当する。
